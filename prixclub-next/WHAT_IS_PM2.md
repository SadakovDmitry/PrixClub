# 🤔 Что такое PM2?

## 📖 Простыми словами

**PM2** — это программа, которая **держит ваш сайт запущенным постоянно** в фоне на сервере.

---

## 🤷 Зачем он нужен?

### Без PM2:

```bash
# Вы запускаете сайт
npm start

# Сайт работает...
# ✅ Всё хорошо

# ВЫ ЗАКРЫВАЕТЕ ТЕРМИНАЛ
# ❌ Сайт останавливается!

# Получается, чтобы сайт работал 24/7,
# нужно держать терминал открытым всё время
```

### С PM2:

```bash
# Вы запускаете сайт через PM2
pm2 start npm --name prixclub -- start

# Сайт работает в фоне
# ✅ Можно закрыть терминал
# ✅ Можно выйти из SSH
# ✅ Сайт работает 24/7
# ✅ Автоматически перезапускается при ошибках
```

---

## ✅ Преимущества PM2

1. **Сайт работает постоянно** — не нужно держать терминал открытым
2. **Автоперезапуск** — если сайт упал, PM2 его поднимет сам
3. **Логи** — можно посмотреть историю работы сайта
4. **Автозапуск при перезагрузке сервера** — после `pm2 startup`
5. **Несколько сайтов** — можно запустить несколько проектов одновременно

---

## 📋 Основные команды

### Запуск

```bash
# Запустить сайт
pm2 start npm --name prixclub -- start

# Сохранить конфигурацию (чтобы сайт оставался запущенным)
pm2 save

# Настроить автозапуск при перезагрузке сервера
pm2 startup
```

### Управление

```bash
pm2 list              # Показать все запущенные сайты
pm2 status            # Статус сайтов
pm2 stop prixclub     # Остановить сайт
pm2 start prixclub    # Запустить сайт
pm2 restart prixclub  # Перезапустить сайт
pm2 delete prixclub   # Удалить сайт из PM2
```

### Логи

```bash
pm2 logs prixclub          # Показать логи сайта
pm2 logs prixclub --err    # Только ошибки
pm2 logs prixclub --lines 100  # Последние 100 строк
```

---

## 🔄 Как это работает?

### Без PM2:

```
Ваш компьютер/сервер:
├── Терминал открыт
│   └── npm start запущен
│       └── Сайт работает на порту 3000
```

Если закрыть терминал → сайт останавливается ❌

### С PM2:

```
Ваш сервер:
├── PM2 (работает как демон в фоне)
│   ├── Процесс 1: prixclub (npm start)
│   │   └── Сайт работает на порту 3000
│   └── Процесс 2: другой-сайт (если есть)
```

PM2 следит за процессами 24/7 → сайт всегда работает ✅

---

## 📊 Пример вывода `pm2 status`

```
┌─────┬────────────────┬─────────┬─────────┬─────────┬──────────┐
│ id  │ name           │ status  │ cpu     │ memory  │ uptime   │
├─────┼────────────────┼─────────┼─────────┼─────────┼──────────┤
│ 0   │ prixclub       │ online  │ 2%      │ 150 MB  │ 2h 30m   │
└─────┴────────────────┴─────────┴─────────┴─────────┴──────────┘
```

- **name** — название сайта (prixclub)
- **status** — online = работает ✅
- **cpu** — использование процессора
- **memory** — использование памяти
- **uptime** — сколько работает

---

## 🚀 Как установить и использовать

### 1. Установка (один раз)

```bash
sudo npm install -g pm2
```

### 2. Запуск сайта

```bash
cd /var/www/sites/prixclub-site/prixclub-next
pm2 start npm --name prixclub -- start
```

### 3. Сохранить настройки

```bash
pm2 save
```

### 4. Настроить автозапуск при перезагрузке

```bash
pm2 startup
# Скопируйте команду, которую покажет PM2, и выполните её
```

---

## 🎯 Зачем это нужно для вашего проекта?

### Ваш Next.js сайт

После `npm start` сайт запускается на порту 3000, но:
- Если закрыть терминал → остановится ❌
- Если перезагрузить сервер → остановится ❌
- Если произойдет ошибка → остановится ❌

### С PM2

После `pm2 start npm --name prixclub -- start`:
- Работает 24/7 ✅
- Можно выходить из SSH ✅
- Перезапуск сервера → автоматический запуск ✅
- Ошибка → автоматический перезапуск ✅

---

## 🔍 Полезные команды для отладки

```bash
# Посмотреть, что происходит с сайтом
pm2 logs prixclub

# Остановить сайт для обновления
pm2 stop prixclub

# Обновить код
git pull
npm run build

# Запустить снова
pm2 start prixclub

# Или сразу перезапустить
pm2 restart prixclub

# Удалить старую версию и запустить новую
pm2 delete prixclub
pm2 start npm --name prixclub -- start
```

---

## ⚠️ Важно помнить

1. **PM2 — это менеджер процессов**, а не часть вашего сайта
2. **После установки** он работает постоянно в фоне
3. **`pm2 save`** нужен, чтобы настройки сохранились
4. **`pm2 startup`** нужен, чтобы сайт запускался при перезагрузке сервера
5. **Не нужно запускать** `npm start` руками, PM2 делает это сам

---

## 🆚 PM2 vs npm start

| Без PM2 | С PM2 |
|---------|-------|
| npm start | pm2 start npm --name prixclub -- start |
| Работает пока открыт терминал | Работает 24/7 |
| Останавливается при ошибке | Автоперезапуск |
| Нужно запускать руками после перезагрузки | Автозапуск |
| Сложно смотреть логи | pm2 logs |
| Нет мониторинга | pm2 status, pm2 monit |

---

## 📚 Дополнительно

### Полезные PM2 команды:

```bash
pm2 monit              # Монитор в реальном времени
pm2 reload prixclub    # Graceful reload (без остановки)
pm2 scale prixclub 4   # Запустить 4 копии сайта
pm2 reset prixclub     # Сбросить счетчики
```

### Для вашего проекта:

```bash
# Полный цикл работы:
git pull                    # Скачать обновления
npm run build              # Собрать проект
pm2 restart prixclub       # Перезапустить сайт

# Проверка:
pm2 status                 # Статус
pm2 logs prixclub          # Логи
curl http://localhost:3000 # Проверка работы
```

---

## ✨ Итог

**PM2** — это **необходимый инструмент** для продакшн серверов.

Без него ваш сайт будет работать только пока вы держите терминал открытым.

С ним — сайт работает **круглосуточно**, **стабильно** и **автоматически**.

**Аналог для Windows:** IIS или просто запуск через Task Scheduler
**Аналог для Docker:** docker-compose с restart: always

Но для Node.js на Linux PM2 — **стандарт индустрии** ✅

